<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Video Continuo</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        /* [Tus estilos CSS existentes] */
    </style>
</head>
<body>
    <!-- [Tus elementos HTML existentes] -->

    <a-scene
        vr-mode-ui="enabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        embedded
        arjs="sourceType: webcam; 
              debugUIEnabled: false; 
              detectionMode: mono; 
              maxDetectionRate: 30;"
    >
        <a-assets>
            <video id="videoTapa" autoplay loop muted crossorigin="anonymous"
                   src="assets/TAPA_VIDEO.mp4" webkit-playsinline playsinline></video>
        </a-assets>

        <a-marker 
            preset="hiro" 
            emiteEvents="true" 
            id="hiro-marker"
            smooth="true"
            smoothCount="10"
            smoothTolerance="0.01"
            smoothThreshold="5"
        >
            <a-entity 
                id="video-container"
                position="0 1.5 0"
                rotation="0 0 0"
                scale="1 1 1"
            >
                <a-video
                    id="ar-video"
                    src="#videoTapa"
                    width="1.6"
                    height="0.9"
                    position="0 0 0"
                    rotation="-90 0 0"
                ></a-video>
            </a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const scene = document.querySelector('a-scene');
            const loader = document.querySelector('.arjs-loader');
            const markerStatus = document.getElementById('marker-status');
            const video = document.querySelector('#videoTapa');
            const videoContainer = document.querySelector('#video-container');
            let videoStarted = false;
            let keepPlaying = false; // Bandera para continuar reproducción

            // Ocultar loader
            scene.addEventListener('loaded', () => {
                setTimeout(() => {
                    loader.style.display = 'none';
                    video.loop = false; // Desactivamos el loop
                }, 2000);
            });
            
            // Manejar eventos del marcador
            const hiroMarker = document.getElementById('hiro-marker');
            
            hiroMarker.addEventListener('markerFound', (e) => {
                markerStatus.textContent = "Marcador detectado!";
                markerStatus.style.color = "#4CAF50";
                
                if(!videoStarted) {
                    video.play().then(() => {
                        videoStarted = true;
                        keepPlaying = true; // Activamos la bandera
                    }).catch(e => {
                        console.log("Error al reproducir:", e);
                        markerStatus.textContent += " (Error con video)";
                    });
                }

                // Escalado basado en distancia
                const markerPosition = e.target.object3D.position;
                const cameraPosition = document.querySelector('[camera]').object3D.position;
                const distance = markerPosition.distanceTo(cameraPosition);
                
                const newScale = Math.min(Math.max(distance * 0.5, 0.8), 2.5);
                videoContainer.setAttribute('scale', {
                    x: newScale,
                    y: newScale,
                    z: newScale
                });
            });
            
            hiroMarker.addEventListener('markerLost', () => {
                markerStatus.textContent = "Marcador perdido (video continúa)";
                markerStatus.style.color = "#FF9800";
                
                // Forzar continuación de reproducción
                if(videoStarted && keepPlaying) {
                    setTimeout(() => {
                        video.play().catch(e => console.log("Error al reanudar:", e));
                    }, 100);
                }
            });
            
            // Verificar assets
            video.onerror = () => {
                markerStatus.textContent = "Error: No se encontró TAPA_VIDEO.mp4";
                markerStatus.style.color = "#FF5252";
            };

            // Reiniciar estado cuando termina el video
            video.onended = () => {
                markerStatus.textContent = "Video finalizado";
                markerStatus.style.color = "#4CAF50";
                videoStarted = false;
                keepPlaying = false;
            };
            
            // Solución definitiva: Intervalo que verifica el estado del video
            setInterval(() => {
                if(keepPlaying && video.paused) {
                    video.play().catch(e => console.log("Auto-reproducción:", e));
                }
            }, 500); // Verifica cada 500ms
        });
    </script>
</body>
</html>
